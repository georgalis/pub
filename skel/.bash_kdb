#!/bin/bash

# kdb mvp 5d5 horis 
#
# Copyright (C) 2015-2019 George Georgalis <george@galis.org>
# All rights reserved. No use or redistribution allowed.
# Including but not limited to algorithms, format, procedures
# and data process function(s). Managed data remains under
# respective copyright of the owners.
#
# Licensing: https://ko-fi.com/dot4space
# Questions: George Georgalis <george@galis.org>

#ks knowledge motive curation query cache pointer db
# 5b9402df %ks curation database cdb (kdb lql) spec
# 5b6cc5aa %ks k4db prefix for development
# 5b56228b %ks design kdb attachments user guide, template spec
# 5afb26f0 %ks mesh chatter (coprocedures)
# 5ad27718 %ks knowledgendian kdb lql spec
# 5a8c6db4 %ks period scheduler and task supervisor spec
# 59dab11b %ks sub kdb idk tools shell functions scraps hex tables
# 59d94184 %ks isbe k4 schema, LQL, knowledge database, k4db Literate Query Language spec
# 59c7febc %ks isbe k4 markdown mermaid mmd spec
# 59bc5f4a %ks isbe kdb tables, types, path, files hist
# 20150807 the only epoch ever used for intervals

arpa ()
{
    [ -z "$1" ] && echo -n "An ip address on the command line returns its ";
    echo "$(ptr "$1")in-addr.arpa"
}
chkerr ()
{
    [ "$*" ] && {
        logerr "$*";
        stderr "$*";
        return 1
    } || true
}
chkwrn ()
{
    [ "$*" ] && {
        logwrn "$*";
        stdwrn "$*";
        return 0
    } || true
}
ecc ()
{
    echo "$2" | cut -c "$1" | sed 's/\^.*//g'
}
ecp ()
{
    echo "$2" | cut -d '^' -f "$1" | sed 's/\^.*//g'
}
idktjz ()
{
    chkwrn "Function works but revisit procedure... noop";
    return 1;
    find -d "$1" -maxdepth 0 -type d || {
        chkwrn "$0 : Not directory : $1";
        return $?
    };
    find -d "$1" -maxdepth 1 -mindepth 1 -name 40000000 || {
        chkwrn "$0 : Not exist $1/40000000";
        return $?
    };
    find -d "$1" -type d -empty -delete;
    find -d "$1" -mindepth 1 -type f | tar cjf "$1"/0x40m.tjf -T - && find -d "$1" -mindepth 1 -type f -not -name 0x40m.tjf -not -name 40000000 -delete;
    find -d "$1" -mindepth 1 -type d -empty -delete;
    head "$1"/40000000 >> "$1"/40000000;
    echo "$1"/0x40m.tjf >> "$1"/40000000;
    tar tjf "$1"/0x40m.tjf >> "$1"/40000000
}
k ()
{
    $k4db_logstd "start $$ : k4since='$k4since' $FUNCNAME $*";
    local ptrnxd="$k4db/$k4_pool/ptrnx";
    set $(k4_inptr "$1") || chkerr "$FUNCNAME : error k4_inptr arg1='$1' (bfd7c86)" || return 1;
    k4="$1";
    n="$3";
    [ -e "$k4" ] || chkerr "$FUNCNAME : invalid k4='$k4' (bcf678a)" || return 1;
    $EDITOR "$k4";
    k4db_kseq "$k4";
    k4db_validate_k4 "$k4" || return 1;
    [ -e "${k4},v" ] || ci -m"(by $FUNCNAME)" -l -t-kdb -q "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    k4db_idx "$k4";
    k4_env_wlink "$k4";
    k4db_mknk4 "0" "$k4";
    k4db_mknk4 "$n" "$k4";
    k4db_hl '-';
    k4_list_tags;
    k4db_hl '.';
    k4_list_kc;
    k4db_hl '-';
    k4_headg "$k4_topic" "$k4";
    k4_inventory "$k4";
    $k4db_logstd "end $$ : k4since='$k4since' $FUNCNAME $*"
}
k4_body ()
{
    local k4="$1";
    awk '/^$/,0' "$k4"
}
k4_chain ()
{
    chkwrn $FUNCNAME use k4_env_wlink;
    $k4db_fstart;
    k4db_validate_k4 "$k4" || return 1;
    [ -e "$k4db/$k4_env/kc" ] && mv -i -f "$k4db/$k4_env/kc" "$k4db/$k4_env/kc~";
    k4_headg '^%kc\ ' "$k4" > "$k4db/$k4_env/kc";
    [ -e "$k4db/$k4_env/kl" ] && mv -i -f "$k4db/$k4_env/kc" "$k4db/$k4_env/kl~";
    k4_headg '^%km\ ' "$k4" | sed -e 's/^%km\ /%kl /' -e 's/_/ /g' | awk '{printf "%s %s ",$5,$6}' > "$k4db/$k4_env/kl";
    k4_headg '^%ks\ ' "$k4" >> "$k4db/$k4_env/kl";
    $k4db_fstop
}
k4_env_r_kc ()
{
    $k4db_fstart;
    local env="$k4db/$k4_pool/$k4_env";
    [ -s "$env/kc" ] && cat "$env/kc" || {
        [ -s "$env/kc~" ] && cat "$env/kc~"
    };
    $k4db_fstop
}
k4_env_r_kl ()
{
    $k4db_fstart;
    local env="$k4db/$k4_pool/$k4_env";
    [ -s "$env/kl" ] && cat "$env/kl" || {
        [ -s "$env/kl~" ] && cat "$env/kl~"
    };
    $k4db_fstop
}
k4_env_wlink ()
{
    $k4db_fstart;
    [ "$1" ] && local k4="$1" kl;
    k4db_validate_k4 "$k4" || return 1;
    local env="$k4db/$k4_pool/$k4_env";
    [ -s "$env/kc" ] && mv -i -f "$env/kc" "$env/kc~";
    k4_headg '^%kc\ ' "$k4" > "$env/kc";
    [ -s "$env/kl" ] && mv -i -f "$env/kl" "$env/kl~";
    kl="$(k4_headg '^%kk\ ' "$k4" | k4db_squash_defaults | k4_squeeze )";
    [ "$kl" ] || kl="$(
        { k4_headg '^%km\ ' "$k4" | sed  -e 's/_/ /g' | awk '{printf "%%kl %s %s %s ",$5,$6,$7}'
          k4_headg '^%ks\ ' "$k4" ;} | k4_squeeze )";
    $k4db_fstop
}
k4_headg ()
{
    local e="$1" k4="$2";
    awk 'NR==1,/^$/' "$k4" | awk '!/^$/' | grep -E "$e"
}
k4_headg_arg ()
{
    local e="$1" n="$2" k4="$3";
    k4_headg "$e" "$k4" | awk -v n="$n" '{printf "%s\n",$n}'
}
k4_headv ()
{
    local e="$1" k4="$2";
    awk 'NR==1,/^$/' "$k4" | awk '!/^$/' | grep -vE "$e"
}
k4_help ()
{
    cat  <<EOF
======== Nomenclature:
 k{name}     user shell function
 k4_{name}   function on elements
 k4db_{name} function on entire db

${FUNCNAME}_1 : Major commands
${FUNCNAME}_2 : Primitive functions
${FUNCNAME}_3 : Unit operations
${FUNCNAME}_4 : Development
${FUNCNAME}_5 : Environment
${FUNCNAME}_6 : GLOSSARY
${FUNCNAME}_7 : PATHs
${FUNCNAME}_8 : K4 file format
${FUNCNAME}_9 : All of the above
EOF

}
k4_help_1 ()
{
    local c;
    cat  <<EOF
======== Major commands #:o
 $(c='#:o' ; grep -Ev '^(#|\$|	)' "$k4db_fun" | grep "$c" | sed -e "s/ ().*$c/	:/"   -e "s/$c/ :/")
EOF

}
k4_help_2 ()
{
    local c;
    cat  <<EOF
======== Primitive functions #::
 $(c='#::' ; grep -Ev '^(#|\$|	)' "$k4db_fun" | grep "$c" | sed -e "s/ ().*$c/	:/"   -e "s/$c/ :/")
EOF

}
k4_help_3 ()
{
    local c;
    cat  <<EOF
======== Unit operations #:>
 $(c='#:>' ; grep -Ev '^(#|\$|	)' "$k4db_fun" | grep "$c" | sed -e "s/ ().*$c/	:/"   -e "s/$c/ :/")
EOF

}
k4_help_4 ()
{
    local c;
    cat  <<EOF
======== Development #:-
 $(c='#:-' ; grep -Ev '^(#|\$|	)' "$k4db_fun" | grep "$c" | sed -e "s/ ().*$c/	:/"   -e "s/$c/ :/")
EOF

}
k4_help_5 ()
{
    local c;
    cat  <<EOF
======== Environment
$(export c='#:$' ; grep -Ev '^(#|\$|	)' "$k4db_fun" | grep "$c" )
$(grep ^export "$k4db_fun")
EOF

}
k4_help_6 ()
{
    cat  <<EOF
======== GLOSSARY
 k4    kdb file and/or path
 k4db  set of k4
 c     query k4db records
 k     act on specific c result
EOF

}
k4_help_7 ()
{
    cat  <<EOF
======== PATHs
 \$k4db/pool/1/ cumulative logs and ptr
 \$k4db/pool/2/ performance indices

 \$k4db/pool/0/ptrid/\$uid
======== FILEPATHs

   local k4d_pool="$k4_pool/$(k4epoch)"
   # mkdir -p pool query directory
    # qury 0
    # root  dot4
    # pool  ${root}/pool/0/...
    # qury  ${root}/0/xsss^/ ${epoch}${span}^
    # ddir  ${root}/${epoch}${span}^
    # k4    ${root}/${epoch}${span}^/_${epoch}.kdb
    # link  ${root}/${epoch}${span}^/^/_${epoch}${span}.kdb
 \$k4db/0/5/c11d 5 5c11d ropr c11d # k4epoch | k4d dot4/0
 \$k4db/pool/: misc tmp files
X\$k4db/pool/0/{ep}/0.log: primary search log
X\$k4db/pool/0/{ep}/1.cmd: invocation command
 \$k4db/pool/0/uidln/\$uid : uid ([:xdigit:]]\{16\}) named link to k4 file
 \$k4db/pool/0/ptrid/\$uid : ptr data (2 lines: k4 path and uid) of k4 uid ([:xdigit:]]\{16\})
 \$k4db/pool/0/ptrnx/\$nx : 0x numbered link to ptrid/\$uid
 \$k4db/pool/0/tx.\$FUNCNAME}.0 : benchmark start time
 \$k4db/pool/0/tx.\$FUNCNAME}.1 : benchmark stop time
X\$k4db/pool/0/{ep}/xss/'[[:xdigit:]]\{24\}$': primary search result (^k4 %k*)
 \$k4db/pool/1/\$(date "+%Y%m%d")/ptrid/: ptrid for abandoned results
 \$k4db/pool/1/xss/{xss}: secondary search result {xss} link to pool/0/*/xss/[[:xdigit:]]\{24\} (^k4 %k*)
X\$k4db/pool/1/{kx}/{xss}: secondary search, xss links to pool/0/*/xss/[[:xdigit:]]\{24\} (^k4 %ks %kx)
 \$k4db/pool/1/secondary.log: secondary search log
 \$k4db/4/: display search index, epoch bundle (local cache)
 \$k4db/4/0/0: last (^k4 %ks %kx)
 \$k4db/4/0/1: prior (^k4 %ks %kx)
 \$k4db/4/0/2: prior (^k4 %ks %kx)
 \$k4db/4/0/3: prior (^k4 %ks %kx)
 \$k4db/4/0/4: prior (^k4 %ks %kx)
 \$k4db/4/0/5: prior (^k4 %ks %kx)
 \$k4db/4/0/6: prior (^k4 %ks %kx)
 \$k4db/4/0/7: prior (^k4 %ks %kx)
?\$k4db/4/0/{epoch}: cumulative prior display, expires (^k4 %ks %kx)
 \$k4db/4/{epoch}/xss/{xss}: layer {epoch} search files, cumulative log, from pool/1/* on epoch reset
 \$k4db/4/{epoch}/nx/{nx}: layer {epoch} search files, cumulative log, from pool/1/* on epoch reset
X\$k4db/4/{epoch}/kx/{kx}: layer {epoch} search files, cumulative log, from pool/1/* on epoch reset
 \$k4db/4/{epoch}/0.log: cumulative log, from pool/1/secondary.log on epoch reset
 \$k4db/5/: kdb master (best available)
 \$k4db/6
 \$k4db/tag.tbl
 \$k4db/include-bash
 \$k4db/.git
 \$k4db/design
 \$k4db/dev
 \$k4db/bin
 \$k4db/man
 \$k4db/   ./4/{tag} : list of dot3
 \$k4db/   ./3/{[:xdigit:]*/}/ : cache index of
EOF

}
k4_help_8 ()
{
    grep '^	' "$k4db_fun";
    cat  <<'EOF'
EOF

}
k4_help_9 ()
{
    k4_help_1;
    echo;
    k4_help_2;
    echo;
    k4_help_3;
    echo;
    k4_help_4;
    echo;
    k4_help_5;
    echo;
    k4_help_6;
    echo;
    k4_help_7;
    echo;
    k4_help_8
}
k4_inptr ()
{
    $k4db_logstd "start $$ : $FUNCNAME $*";
    local ptr="$1" ptrf k4 id nx;
    local ptrid="$k4db/$k4_pool/ptrid";
    local ptrnx="$k4db/$k4_pool/ptrnx";
    [ "$ptr" ] || ptr=0;
    [ "$ptrf" ] || ptrf="$(find "$ptrnx" -name "${ptr}"  -regex ".*/ptrnx/[[:xdigit:]]*$" )";
    [ "$ptrf" ] || ptrf="$(find "$ptrid" -name "${ptr}"  -regex ".*/ptrid/[[:xdigit:]]\{16\}$" )";
    [ "$ptrf" ] || ptrf="$(find "$ptrid" -name "${ptr}*" -regex ".*/ptrid/${ptr}[[:xdigit:]]\{8\}$" )";
    [ "$ptrf" ] || ptrf="$(find "$ptrnx" -name $(cd "$ptrnx" ; ls | sort -n | tail -n1))";
    [ "$ptrf" ] || chkerr "$FUNCNAME : no match for ${ptr} : $ptrid $ptrnx : (bcfce6d)" || return 1;
    [ "$(echo "$ptrf" | awk 'END{print NR}')" = 1 ] || chkwrn "$FUNCNAME : multi match for ptr='${ptr}' $FUNCNAME bug (bcf6458)";
    [ "$ptrf" ] && k4="$(head -n1 "$ptrf")";
    [ "$ptrf" ] && id="$(tail -n1 "$ptrf")";
    [ "$ptrf" ] && nxp="$(find "$ptrnx" -type f -exec grep --files-with-matches "$id" \{\} \; | awk 'NR==1' )";
    echo $k4 $id ${nxp##*/};
    $k4db_logstd "end $$ : $FUNCNAME $*"
}
k4_inventory ()
{
    $k4db_logstd "start $$ : $FUNCNAME $*";
    local k4="$1" p="${1%/*}" k="${1##*/}";
    local not_find="-not ( -name *,v -o -name $k -o -name ^ )";
    find "$p" -mindepth 1 -prune -type f -name "$k" -exec printf "        K4 %s \n" \{\} \;;
    find "$p" -mindepth 1 -prune -type d $not_find -exec printf "       DIR %s/\n" \{\} \; | sort -d;
    find "$p" -mindepth 1 -prune -type f $not_find -exec printf "      FILE %s \n" \{\} \; | sort -d;
    {
        find "$p" -mindepth 1 -prune -type f $not_find | awk 'END{printf "(%d/",FNR}';
        find "$p" -type f $not_find | awk 'END{printf "%d) ",FNR}';
        du -sh "$p/"
    } | awk '{printf "%-10s %s %s\n%-10s %s\n","     TOTAL",$1,$2,"      ROOT",$3 }';
    $k4db_logstd "end $$ : $FUNCNAME $*"
}
k4_list_kc ()
{
    local _list_kc="$k4db/$k4_list/kc";
    [ -e "$_list_kc" ] && cat "${_list_kc}" | sort | column
}
k4_list_tags ()
{
    local count="$1";
    local _idx_dir="$k4db/$k4_idx";
    local _search="$(echo $k4_search | sed -e 's/^^%//' -e 's/[()]//g' -e 's/[\\ ]//'g | tr '|' '\n' | sort | tr '\n' ',')";
    local _idx_search="$_idx_dir/${_search}";
    [ "$count" ] || count=100;
    tr '%' '\n' < "$_idx_search" | sed -e '/^kt /!d' -e 's/^kt //' | tr ' ' '\n' | sed '/^$/d' | sort -i | uniq -ic | sort -n | tail -n "$count" | awk '{print $2}' | sort -i | column
}
k4_raw ()
{
    sed -e 's/^%[^ ]* //' -e 's/#.*//' -e 's/ $//'
}
k4_squeeze ()
{
    tr -s '\n\t' ' ' | sed 's/[ ]*$//'
}
k4_wrapregex ()
{
    local m="$1";
    local n="$2";
    [ "$m" ] || return 0;
    [ "$n" ] && {
        shift;
        shift;
        $FUNCNAME "$m|$n" $@
    } || echo "($m)"
}
k4db_addxd ()
{
    local n="0x$1" d="$2";
    echo $(( $n + $d )) | awk '{printf "%x",$1}'
}
k4db_clean ()
{
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd 3ddf08" || return 1;
    find "$k4db" -depth -type d -empty -delete
}
k4db_clean_ks ()
{
    chkerr "$FUNCNAME empty";
    return 1
}
k4db_clean_name ()
{
    tr -dc '\053-\071\101-\132\137\141-\172'
}
k4db_clean_path ()
{
    chkerr "$FUNCNAME empty";
    return 1
}
k4db_clean_xs ()
{
    chkerr "$FUNCNAME empty";
    return 1
}
k4db_clean_xss ()
{
    chkerr "$FUNCNAME empty";
    return 1
}
k4db_fk4 ()
{
    $k4db_logstd "find ${k4db} ${k4since} -regex '.*_/.*' -prune -type f -name '*.kdb'";
    find ${k4db} ${k4since} -regex '.*_/.*' -prune -type f -name '*.kdb';
    $k4db_logstd "find ${k4db} ${k4since} -regex '.*^/.*' -prune -type f -name '*.kdb'";
    find ${k4db} ${k4since} -regex '.*^/.*' -prune -type f -name '*.kdb'
}
k4db_fold ()
{
    [ -t 1 ] && {
        local cols="$(tput cols)";
        fold -s -w $cols
    } || cat
}
k4db_hl ()
{
    local char="$1";
    [ "$char" ] || char="-";
    [ -t 1 ] && {
        local cols=$(tput cols);
        tput md;
        printf "%*s" $cols '' | tr ' ' "$char";
        tput me
    } || echo "$char"
}
k4db_idx ()
{
    local k4;
    local _idx_dir="$k4db/$k4_idx";
    local _search="$(echo $k4_search | sed -e 's/^^%//' -e 's/[()]//g' -e 's/[\\ ]//'g | tr '|' '\n' | sort | tr '\n' ',')";
    local _idx_search="$_idx_dir/${_search}";
    local _list_dir="$k4db/$k4_list";
    local _kc _list_kc="$_list_dir/kc";
    [ -d "$_idx_dir" ] || {
        chkerr "$FUNCNAME _idx_dir not a dir : $_idx_dir (d24ca6a)";
        return 1
    };
    [ -w "$_idx_dir" ] || {
        chkerr "$FUNCNAME _idx_dir not writeable : $_idx_dir (d24ca6b)";
        return 1
    };
    [ -x "$_idx_dir" ] || {
        chkerr "$FUNCNAME _idx_dir not executeable :$_idx_dir (d24ca6c)";
        return 1
    };
    [ -e "$_idx_search" ] || touch "$_idx_search";
    [ -e "$_list_kc" ] || touch "$_list_kc";
    [ "$1" ] && {
        k4="$1";
        k4db_validate_k4 "$k4";
        _kc="$(k4_headg '^%kc ' "$k4" | k4db_squash_defaults )";
        [ "$_kc" ] && {
            grep -q "^$_kc" "$_list_kc" || echo "$_kc" >> "$_list_kc"
        };
        printf "%s " "$k4" >> "$_idx_search";
        k4_headg "${k4_search}" "$k4" | k4db_squash_defaults | sed '/%km /s/_/ /g' | k4_squeeze >> "$_idx_search"
    };
    [ "$1" ] || {
        local _idx_search_n="$(mktemp "${_idx_search}-XXXX")";
        local _list_kc_n="$(mktemp "${_list_kc}-XXXX")";
        k4db_fk4 | while read k4; do
            _kc="$(k4_headg '^%kc ' "$k4" | k4db_squash_defaults )";
            [ "$_kc" ] && echo "$_kc" >> "$_list_kc_n";
            printf "%s " "$k4" >> "$_idx_search_n";
            k4_headg "${k4_search}" "$k4" | k4db_squash_defaults | sed '/%km /s/_/ /g' | k4_squeeze >> "$_idx_search_n";
        done;
        sort -u "$_list_kc_n" > "${_list_kc_n}.sort" && mv -i -f "${_list_kc_n}.sort" "${_list_kc}" && rm -i -f "$_list_kc_n";
        sort -du "${_idx_search_n}" > "${_idx_search_n}.sort" && mv -i -f "${_idx_search_n}.sort" "${_idx_search}" && rm -i -f "${_idx_search_n}"
    }
}
k4db_idx_dt ()
{
    local arg1="$1";
    [ "$arg1" ] || arg1="$(cat)";
    tr -dc ' %+,-.0123456789:;@ABCDEFGHIJKLMNOPQRSTUVWXYZ^_abcdefghijklmnopqrstuvwxyz' | tr -s ' '
}
k4db_init ()
{
    local cksum fail="fail";
    local h="$(cd ~ && pwd -P)";
    [ "$k4db" = "$h/dot4" ] || {
        chkerr "$FUNCNAME : unexpected k4db : $k4db : bc11a92";
        fail="${fail} bc11a92";
        return 1
    };
    export k4="$k4db/0.kdb";
    [ "$LC_ALL" ] || export LC_ALL="C";
    export LC_ALL="C";
    export k4_session="0";
    export k4_pool="0/%";
    export k4_list="0/=";
    export k4_idx="0/^";
    export k4_env="0/_";
    export k4_hst="0/,";
    export k4db_tags="$k4db/c/etc/tags.tbl";
    export k4db_ntag="$k4db/c/etc/ntag.tbl";
    export k4db_logstd="true #";
    export k4db_logstd="k4db_logstd";
    export k4db_fstart="$k4db_logstd"\ 'start $$ : $FUNCNAME $*';
    export k4db_fstop="$k4db_logstd"\ 'stop  $$ : $FUNCNAME $*';
    export k4_unlong='k4db_fold';
    export k4_unlong='k4db_trunc';
    export k4case='-i';
    export k4_search="^%(ks|kt|kk|kc|kp|kj|kr|kl|km|kd)\ ";
    export k4_topic="^%(ks|kt|kk|kc|kp|kj|kl)\ ";
    export k4_ht_strftime="+%s %Y%m%d %H%M %Z %z %a";
    mkdir -p "$k4db/$k4_pool" "$k4db/$k4_list" "$k4db/$k4_idx" "$k4db/$k4_env" "$k4db/$k4_hst" || {
        chkerr "cannot create k4db standard directory(ies) $k4db/$k4_pool $k4db/$k4_list $k4db/$k4_idx $k4db/$k4_env $k4db/$k4_hst : bc3fee0";
        fail="${fail} d49f583"
    };
    mkdir -p "$k4db/$k4_pool/ptnx" "$k4db/$k4_pool/ptid" "$k4db/$k4_pool/idln" || {
        chkerr "cannot create $k4db/$k4_pool/ptnx $k4db/$k4_pool/ptid $k4db/$k4_pool/idln ($k4db/$k4_pool) : bc3fef1";
        fail="${fail} d49f8c2"
    };
    mkdir -p "$k4db/$k4_pool/$k4_idx" "$k4db/$k4_pool/$k4_env" "$k4db/$k4_pool/$k4_hst" || {
        chkerr "cannot create k4db standard directory(ies) $k4db/$k4_pool/$k4_idx $k4db/$k4_pool/$k4_env $k4db/$k4_pool/$k4_hst : bc3fee0";
        fail="${fail} bc3fee0"
    };
    mkdir -p "$k4db/$k4_pool/ptrnx" "$k4db/$k4_pool/ptrid" "$k4db/$k4_pool/uidln" || {
        chkerr "cannot create k4db/k4_pool/ptrnx k4db/k4_pool/ptrid k4db/k4_pool/uidln ($k4db/$k4_pool) : bc3fef1";
        fail="${fail} bc3fef1"
    };
    touch -t 201508060000 "$k4db/$k4_pool/nulltime" || {
        chkerr "$FUNCNAME : cannot create k4db/k4_pool/nulltime : $k4db/$k4_pool/nulltime : bc11d49";
        fail="${fail} bc11d49"
    };
    touch "$k4db/$k4_pool/lasttime" || {
        chkerr "$FUNCNAME : cannot create k4db/k4_pool/lasttime : $k4db/$k4_pool/lasttime : bc11da6";
        fail="${fail} bc11da6"
    };
    touch "$k4db/$k4_list/kc";
    [ "$fail" = "fail" ] && return 0 || chkerr "$FUNCNAME : $fail (bd1faaa)"
}
k4db_kseq ()
{
    local k4=$1;
    k4db_validate_k4 "$k4" || return 1;
    local k4d="${k4%/*}";
    local k4x="$(mktemp ${k4d}/__tmp.kdb-XXXX)";
    local kre order kinds="
# %ks # subject matter
# %kt # tag list
# %kk # entry keyord
# %kc # entry class
# %kr # matrix reason
# %kp # hier superord
# %kj # motive subord
# %kl # hist link
# %kn # interval align
# %ko # origin owner
# %km # meta hash
# %kpi # pi value
# %kd # markdown index
# %kv # value key
# %ki # review interval
# %ke # event begin
# %kz # event end
";
    kre="^($(echo "$kinds" | sed -e '/^$/d' | awk '{printf "%s",$2"|"}' | sed -e 's/|$//'))\\ ";
    order="$(echo "$kinds" | sed -e '/^$/d' | awk '{print $2}')";
    for kind in $order;
    do
        k4_headg "^${kind}\ " "$k4" >> "$k4x";
    done;
    k4_headv "$kre" "$k4" >> "$k4x";
    k4_body "$k4" >> "$k4x";
    [ -e "${k4},v" ] || ci -m"(by $FUNCNAME)" -l -t-kdb -q "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    cat "$k4x" > "$k4";
    touch "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    rm -i -f "$k4x"
}
k4db_linkcount ()
{
    local k4_term_lines=$(( $(tput li) - 5 ));
    local ptrnxc="$(find "$k4db/$k4_pool/ptrnx" -type f | awk 'END{printf NR}' )";
    local uidlnc="$(find "$k4db/$k4_pool/uidln" -type f | awk 'END{printf NR}' )";
    [ $ptrnxc -ge $k4_term_lines ] && printf ">>> overflow ";
    printf "% 3s/%s/%s %s" "$ptrnxc" "$uidlnc" "$k4_term_lines" "$*";
    [ $ptrnxc -eq 0 ] && chkwrn "null match"
}
k4db_logstd ()
{
    echo "$*" | tai64n >> "${k4db}/${k4_pool}/log"
}
k4db_mknk4 ()
{
    local n="$1" k4="$2";
    [ -f "$k4" ] || {
        chkerr "$FUNCNAME k4 not a regular file : k4=$k4 {5bacnoun}";
        return 1
    };
    set $(k4_headg '^%km ' "$k4" | head -n1 | sed 's/_/ /g');
    [ "${#3}${#4}" = "88" ] || {
        chkerr "$FUNCNAME unexpected km 3 4 == '$xs $ss' k4=$k4 (d324a55)";
        return 1
    };
    ln -f "$k4" "$k4db/$k4_pool/uidln/$3$4";
    {
        echo "$k4";
        echo "$3$4"
    } > "$k4db/$k4_pool/ptrnx/$n";
    ln -f "$k4db/$k4_pool/ptrnx/$n" "$k4db/$k4_pool/ptrid/$3$4"
}
k4db_squash_defaults ()
{
    sed -E -e '
        /^%k. .*ord #$/d
        /^%k. .*def #$/d
        /^%k. .*root #$/d
        /^%kk .*# class define #$/d
        /^%kt $/d
        /^%%k(l|r|p)_(%kl )5.* isbe #/d
        /^%%k(l|r|p)_(%kl )5.* self #/d
        /^%%k(l|r|p)_(%kl )5.* self [ ]*# (super|related)/d
        /^%%k(l|r|p)_5.* self [ ]*# (super|related|linked)/d
        /^%%kd_.*index.md$/d
        /^%kc  # class/d
        /^%kc  # hist class/d
        /^%kc blah/d
        /^%kc hist/d
        /^%kc hist # hist class/d
        /^%kc hist exam # class onto/d
        /^%kc hist exmp # class note/d
        /^%kc hist ignore # hist class/d
        '
}
k4db_trunc ()
{
    [ -t 1 ] && {
        local cols="$(tput cols)";
        awk -v cols=$((cols-1)) 'length > cols{$0=substr($0,0,cols)"_"}1'
    } || cat
}
k4db_valid_bg ()
{
    true
}
k4db_valid_cmd ()
{
    local cksum fail="fail";
    [ "$k4db" = "/Users/geo/dot4" ] || {
        chkerr "$FUNCNAME : unexpected k4db : $k4db : bc02189";
        fail="${fail} bc02189"
    };
    [ ${k4_pool##*/} = "%" ] || {
        chkerr "$FUNCNAME : invalid k4_pool : $k4_pool : bbfcf27";
        fail="${fail} bbfcf27"
    };
    [ ${k4_hst##*/} = "," ] || {
        chkerr "$FUNCNAME : invalid k4_hst : $k4_hst : bc029a0";
        fail="${fail} bc029a0"
    };
    [ -d ${k4_hst} ] || {
        chkerr "$FUNCNAME : invalid k4_hst : $k4_hst : d4a0f42";
        fail="${fail} d4a0f42"
    };
    [ -d "$k4db/$k4_pool/ptrnx" ] || {
        chkerr "$FUNCNAME : not a directory k4db/k4_pool/ptrnx : $k4db/$k4_pool/ptrnx : bbfca90";
        fail="${fail} bbfca90"
    };
    [ -d "$k4db/$k4_pool/ptrid" ] || {
        chkerr "$FUNCNAME : not a directory k4db/k4_pool/ptrid : $k4db/$k4_pool/ptrid : bbfca91";
        fail="${fail} bbfca91"
    };
    [ -d "$k4db/$k4_pool/uidln" ] || {
        chkerr "$FUNCNAME : not a directory k4db/k4_pool/uidln : $k4db/$k4_pool/uidln : bbfca92";
        fail="${fail} bbfca92"
    };
    [ -x "$k4db/$k4_pool/ptnx" -a -w "$k4db/$k4_pool/ptnx" ] || {
        chkerr "$FUNCNAME : invalid k4db/k4_pool/ptnx : $k4db/$k4_pool/ptnx : bc02c20";
        fail="${fail} bc02c20"
    };
    [ -x "$k4db/$k4_pool/ptid" -a -w "$k4db/$k4_pool/ptid" ] || {
        chkerr "$FUNCNAME : invalid k4db/k4_pool/ptid : $k4db/$k4_pool/ptid : bc02c21";
        fail="${fail} bc02c21"
    };
    [ -x "$k4db/$k4_pool/idln" -a -w "$k4db/$k4_pool/idln" ] || {
        chkerr "$FUNCNAME : invalid k4db/k4_pool/idln : $k4db/$k4_pool/idln : bc02c22";
        fail="${fail} bc02c22"
    };
    [ -e "$k4db/$k4_pool/nulltime" ] || {
        chkerr "$FUNCNAME : no nulltime : $k4_nulltime : bbfd346";
        fail="${fail} bbfd346"
    };
    [ -e "$k4db/$k4_pool/lasttime" ] || {
        chkerr "$FUNCNAME : no lasttime : $k4_lasttime : bbfd371";
        fail="${fail} bbfd371"
    };
    cksum="$(k4_headg "${k4_search}" /Users/geo/dot4/5/c/4/e/1/a/^/^5c4e1a.kdb | cksum)";
    [ "$cksum" = "4227768052 382" ] || {
        chkerr "$FUNCNAME : failed k4_search cksum : c4e1a";
        fail="${fail} bbeec"
    };
    [ "$fail" = "fail" ] && return 0 || chkerr "$FUNCNAME : $fail";
    return 1
}
k4db_validate_k4 ()
{
    $k4db_fstart;
    local k4="$1";
    [ -f "$k4" ] || chkerr "$FUNCNAME : not a regular file k4='$k4' (bda5b1e)" || return 1;
    k4_headg "^%ks ." "$k4" > /dev/null || {
        chkerr "$FUNCNAME : Invalid k4 : no %ks : $k4";
        return 1
    };
    k4_headg "^%km ." "$k4" > /dev/null || {
        chkerr "$FUNCNAME : Invalid k4 : no %km : $k4";
        return 1
    };
    $k4db_fstop
}
k4db_xss_ddiff ()
{
    local v t0="${1}.0" t1="${1}.1";
    [ -e "$t0" -a -e "$t1" ] || {
        chkerr "$FUNCNAME $1 : Invalid input $t0 $t1 bc4dcae";
        return 1
    };
    shift;
    local pass="$*";
    set $(sed -e 's/_/ /' "$t1" "$t0"         | awk '{print  $1,$2}' | tr ' ' '\n'         | while read v ; do printf '%d\n' "0x$v" ; done         | tr '\n' ' ');
    dc -e "4k $1 $3 - $2 $4 - 1006632959 / + n";
    echo -n " $pass"
}
k4del ()
{
    $k4db_fstart;
    [ "$1" ] && {
        set $(k4_inptr "$1");
        local k4="$1"
    } || local k4="$k4";
    local k4d=$(dirname $k4) || chkerr "$FUNCNAME $1 : error (d2ec9d0)" || return 1;
    local a;
    k4db_validate_k4 "$k4" || return 1;
    k4db_hl '#';
    k4_body "$k4";
    k4db_hl '\';
    k4_headv "$k4_topic" "$k4";
    k4db_hl '.';
    k4_headg "$k4_topic" "$k4";
    k4_inventory "$k4";
    k4db_hl '/';
    chkwrn "DELETE $k4d/";
    read -n1 -p "(y/N) " a;
    echo;
    [ "$a" = "y" ] && {
        k4_env_wlink "$k4";
        rm -i -rf "$k4d/"
    } || chkwrn "$FUNCNAME $1 : cancled"
}
k4dir ()
{
    k4dir_epoch_span $@ | awk '{print $1}'
}
k4dir_epoch_span ()
{
    local prefix="$1" xs=$2 ss=$3;
    [ "$prefix" ] || prefix="$k4db";
    [ -d "$prefix" ] || {
        chkerr "prefix=$prefix not a directory (d1a0a1d)";
        return 1
    };
    [ -w "$prefix" ] || {
        chkerr "prefix=$prefix not writeable (d1a19d5)";
        return 1
    };
    [ "$xs" ] || {
        set $(echo | tai64n | sed -e 's/^@4[0]*//' -e 's/.\{8\}/& /');
        xs=$1 ss=$2
    };
    local result="/${xs}${ss}";
    while [ -d "${prefix}${result%/*}" ]; do
        result="$(echo "$result" | sed -e 's:.*/.:&/:' -e 's://$:/c:' )";
    done;
    {
        echo "$prefix$result" | sed 's:[[:xdigit:]]*$:^:';
        echo "$result" | sed -e 's:/[^/]*$::' -e 's:[^[:xdigit:]]*::g';
        echo "$result" | sed 's:.*/::'
    } | tr '\n' ' ';
    echo
}
k4eid ()
{
    k4km | awk '{print $5}'
}
k4epoch ()
{
    k4dir_epoch_span $@ | awk '{print $2}'
}
k4epochspan ()
{
    k4dir_epoch_span $@ | awk '{print $2,$3}'
}
k4fixkm ()
{
    [ "$1" ] || {
        chkwrn "$FUNCNAME error : null arg1";
        return 1
    };
    local type alpha xs ss k4 arg1=$1 a;
    k4db_fk4 "$k4db" | while read k4; do
        k4_headg '^%km ' "$k4" | grep "$k4case" -qE "$arg1" && {
            set $(k4_headg ^%km\  "$k4" | sed -e 's/_/ /g' );
            local type=$1 alpha=$2 xs=$3 ss=$4;
            set $(k4dir_epoch_span "$k4db" "$xs" "$ss");
            local kd="${k4%/*}" epoch="$2" span="$3";
            local pw="$( gpw 1 $(( ${#epoch} * ${#epoch} / 18 + 4 )) | awk '{printf "%s",$1}' )";
            local k4x="$(mktemp ${kd}/__XXXX)";
            local k4hash="$(python $k4db/sub/base.py $(( 0x$xs + 0x$ss )) 32 )";
            k4_headg '^%(ks|kt|kk|kc|kp|kj|kr|kl)\ ' "$k4" | grep -v "^%km\ " >> "$k4x";
            grep -q ^%kt\  "$k4" || echo "%kt $k4hash tagkey" >> "$k4x";
            grep -q ^%kk\  "$k4" || echo "%kk $k4hash keyord %n 0000 %d 0001 %e $epoch" >> "$k4x";
            grep -q ^%kp\  "$k4" || echo "%kp $epoch $pw # hier superord" >> "$k4x";
            grep -q ^%kj\  "$k4" || echo "%kj $epoch $pw # motive subord" >> "$k4x";
            grep -q ^%kr\  "$k4" || echo "%kr $epoch $pw # matrix root" >> "$k4x";
            grep -q ^%kl\  "$k4" || echo "%kl $epoch $pw # matrix root" >> "$k4x";
            local xa="$(python $k4db/sub/base.py $(( 0x${xs} + 0x${epoch} + ${#epoch} )) 16 | k4_squeeze)";
            local k4span32="$(python $k4db/sub/base.py $((0x$span)) 32 )";
            local hdate="$(date -j -r "$((0x$xs))" "$k4_ht_strftime")";
            echo -n "%km $xa $xs $ss $epoch $k4hash $k4span32 $hdate " >> "$k4x";
            grep ^%km\  "$k4" >> "$k4x";
            k4_headv '^%(ks|kt|kk|kc|kp|kj|kr|kl|km)\ ' "$k4" | grep -v "^%km\ " >> "$k4x";
            grep -q ^%kn\  "$k4" || {
                local kn=$(nevernowf $xs);
                local knfd=$(nevernowd $xs);
                local knfx=$(nevernowx $xs);
                echo "%kn $kn %d $knfd %x $knfx" >> "$k4x"
            };
            grep -q ^%kv\  "$k4" || {
                local v="$(dc -e "$((0x$xs)) 2 / $((0x$xs)) v + p" | awk '{printf "%08x",$1}')";
                local vv="$(dc -e "$((0x$xs$ss)) v 2 / p" | awk '{printf "%x\n",0x$1}')";
                echo "%kv $v %v $vv # value key" >> "$k4x"
            };
            grep -q ^%ki\  "$k4" || {
                local ki="$(k4db_addxd $xs $((86400 * 57)) )";
                local kiht="$(date -j -r 0x$ki "$k4_ht_strftime")";
                echo "%ki $ki $kiht # review interval" >> "$k4x"
            };
            grep -q ^%ke\  "$k4" || {
                local e="$(printf '%x' "$(( $((0x$xs)) - 86400 * 18 ))" )";
                echo "%ke $e # event begin" >> "$k4x"
            };
            grep -q ^%kz\  "$k4" || {
                echo "%kz $xs # event end" >> "$k4x"
            };
            [ -e "$k4" ] && k4_body "$k4" >> "$k4x";
            diff "$k4" "$k4x";
            echo "cat '$k4x' >'$k4' \\";
            echo " && rm '$k4x'"
        };
    done
}
k4k ()
{
    local uidln="$1" uidlnd="$k4db/pool/0/uidln";
    [ "$uidln" ] && k4kr "$uidln" || knkr "$1" || {
        ls "$uidlnd" | while read uidln; do
            k4kr "${uidlnd}/${uidln}";
        done
    }
}
k4ki ()
{
    local days="$1";
    [ "$days" ] || days=57;
    [[ $days =~ ^-?[0-9]+$ ]] || chkerr "$FUNCNAME : arg1 interger expected days='$days' (af7e0)";
    printf '%x' "$(( $(date '+%s') + 86400 * $days ))"
}
k4kl ()
{
    k4kr $@ | sed 's/^%kr /%kl /'
}
k4km ()
{
    local xs="$1" ss="$2" epoch="$3" span="$4";
    [ "$xs" ] || {
        set $(echo | tai64n | tr '\n' ' ' | sed -e 's/^@4[0]*//' -e 's/.\{8\}/& /');
        xs="$1" ss="$2"
    };
    [ "$ss" ] || ss="00000000";
    local epoch="$(echo "$seed" | sed -e 's:/[^/]*$::' -e 's:/::g' )";
    local xa="$(echo 0x$xs 0x$epoch | awk '{printf "%d %d +p\n",$1,$2}' | dc - | awk '{printf "%x \n",$1}')";
    {
        echo "${pxrt}${seed}" | sed -e 's:.*/:& :' -e 's/ .*//';
        echo $xa;
        echo $xs $ss;
        echo $epoch;
        echo "$( gpw 1 $(( ${#epoch} * ${#epoch} / 18 + 4 )) | awk '{printf "%8s",$1}' )";
        echo "$(python $k4db/sub/base.py $(( 0x$xs + 0x$ss + 0x$epoch )) 32)";
        echo "$(python $k4db/sub/base.py $(( 0x$(echo $seed | sed -e 's;.*/;;') )) 32)";
        date -j -r "$((0x$xs))" "$k4_ht_strftime"
    } | k4_squeeze;
    echo
}
k4kr ()
{
    local kl k4="$1";
    k4db_validate_k4 "$k4" || return 1;
    kl="$( { k4_headg '^%kk ' "$k4" | k4db_squash_defaults | sed 's/^%kk /%kr /'
          k4_headg '^%ks ' "$k4" | sed 's/^%ks /%s /' ;} | k4_squeeze )";
    [ "$kl" ] || kl="$( k4_headg '^%km\ ' "$k4" | sed -e 's/_/ /g'               | awk '{printf "%s %s %s ","\%kr",$5,$6}'
            k4_headg '^%ks\ ' "$k4" | sed -e 's/^%ks /%s /' )";
    echo "$kl" | k4_squeeze
}
k4krm ()
{
    local arg1=$1 k4=$2;
    k4db_validate_k4 "$k4" || return 1;
    local k4d="${k4%/*}";
    local k4x="$(mktemp ${k4d}/__tmp.kdb-XXXX)";
    k4_headv "$arg1" "$k4" >> "$k4x";
    k4_body "$k4" >> "$k4x";
    [ -e "${k4},v" ] || ci -m"(by $FUNCNAME)" -l -t-kdb -q "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    cat "$k4x" > "$k4";
    touch "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    rm -i -f "$k4x"
}
k4new ()
{
    local k4="$1" xs="$2" ss="$3" kd;
    [ "$xs" -a "$ss" ] || {
        chkerr "$FUNCNAME { xs and ss } not set (d1c1edd)";
        return 1
    };
    kd="${k4%/*}";
    [ -d "$kd" ] || {
        chkerr "kd=$kd not directory (d1b0a1d)";
        return 1
    };
    [ -w "$kd" ] || {
        chkerr "kd=$kd not writeable (d1b19d5)";
        return 1
    };
    touch "${k4}-new"
}
k4p ()
{
    find $k4db/$k4_pool -name =\* | sed 's/.*0//' | sort -d | column;
    echo $k4_pool | sed 's/.*0/0/'
}
k4pool ()
{
    find "$k4db/$k4_pool/ptrnx" "$k4db/$k4_pool/ptrid" "$k4db/$k4_pool/uidln" -type f || true
}
k4refresh ()
{
    local k4="$1" xs="$2" ss="$3";
    local ok4d="${k4%/*}";
    set $(k4km "$k4db" "$xs" "$ss" );
    local nk4d="${1}";
    mkdir -p "$nk4d";
    ok4d2 = $ok4d rename sans ^;
    mv -i "$ok4d" "$nk4d/$ok4d2"
}
k4setxsss ()
{
    set $(echo | tai64n | sed -e 's/^@4[0]*//' -e 's/.\{8\}/& /');
    xs=$1 ss=$2
}
k4stat ()
{
    local f fs;
    [ "$1" ] && fs="$1" || fs="$(cat)";
    [ "$fs" = "-h" -o "$fs" = "--help" ] && {
        chkwrn "Usage, for arg1 (or per line stdin)";
        chkwrn "return: n-inode chksum size mdate filename"
    } || {
        echo "$fs" | while read f; do
            [ -f "$f" ] && {
                {
                    stat -f '%l %i %m' "$f";
                    cksum "$f"
                } | tr '\n' ' ' | awk '{printf "%x%07x %08x % 8x %8x ",$1,$2,$4,$5,$3}';
                echo "$f"
            } || chkerr "$FUNCNAME : not a regular file : $f";
        done
    }
}
k_ ()
{
    local day="$1";
    $k4db_logstd "begin $$ : k4since='$k4since' $FUNCNAME $day";
    [ "$day" ] || day=3;
    local k4since;
    k4since="-mtime -${day}" kj .;
    $k4db_logstd "end $$ : k4since='$k4since' $FUNCNAME $day"
}
k__ ()
{
    local min="$1";
    $k4db_logstd "begin $$ : k4since='$k4since' $FUNCNAME $min";
    [ "$min" ] || min=90;
    local k4since;
    k4since="-mmin -${min}" kj .;
    $k4db_logstd "end $$ : k4since='$k4since' $FUNCNAME $arg"
}
ka ()
{
    $k4db_logstd "start $$ : $FUNCNAME $*";
    local k4;
    set $(k4_inptr "$1");
    k4="$1";
    [ -e "$k4" ] || chkerr "invalid ptr (no $k4)" || return 1;
    aspell -c "$k4";
    k4db_mknk4 "0" "$k4";
    [ -e "${k4},v" ] || ci -m"(by $FUNCNAME)" -l -t-kdb -m'aspell' -q "$k4";
    [ "${k4}" -nt "${k4},v" ] && ci -m"(by $FUNCNAME)" -l -q "$k4";
    k4_headg "$k4_topic" "$k4";
    k4_inventory "$k4";
    $k4db_logstd "end $$ : $FUNCNAME $*"
}
kc ()
{
    $k4db_logstd "start $$ : $FUNCNAME $@";
    set $(k4_inptr "$1");
    export k4="$1";
    k4db_validate_k4 "$k4" || return 1;
    [ -e "$k4" ] || chkerr "$FUNCNAME no k4='$k4' (bc785a2)" || return 1;
    k4db_hl '#';
    k4_headg "." "$k4" | k4db_squash_defaults;
    k4db_hl '-';
    k4_body "$k4";
    k4db_hl '\';
    k4_headg "$k4_topic" "$k4";
    k4_inventory "$k4";
    k4db_hl '/';
    k4db_mknk4 "0" "$k4";
    $k4db_logstd "end $$ : $FUNCNAME $@"
}
kcs ()
{
    kc $@ | less
}
kg ()
{
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd bc73b10 " || return 1;
    local uidln uid nxp xs data="$1" k4ex="$2";
    local k4_topic k4_search="$k4_search";
    [ "$k4ex" ] && {
        k4_topic="$k4ex" k4_search="$k4ex"
    } || k4_topic="^%ks ";
    k4db_hl '~';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    find $k4db/$k4_pool/uidln -type f | while read uidln; do
        awk 'NR==1,/^$/' "$uidln" | grep -E "$k4_search" | grep $k4case -qE "$data" && {
            nxp=$(grep --files-with-matches "${uidln##*/}" "$k4db/$k4_pool/ptrnx/"* | head -n1 );
            nxp="${nxp##*/}";
            nxp="$(printf "%-3s" "$nxp")";
            xs="${uidln##*/}";
            xs="${xs::8}";
            k4_headg "$k4_topic" "$uidln" | awk -v nxp="$nxp" -v xs="$xs" 'NR==1{sub(/^/," "nxp" "xs" ")}1' | sed -e "s/^%/             %/" | $k4_unlong
        } || {
            uid="${uidln##*/}";
            rm -i -f "$k4db/$k4_pool/ptrid/$uid";
            rm -i -f "$uidln"
        };
    done | $k4_unlong;
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    k4db_hl '/';
    {
        k4db_linkcount ": $FUNCNAME ${k4case} '${filter}' : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | k4_squeeze | $k4_unlong
}
kgl ()
{
    k4_search='^%k(s|m|t|j) ' kg $@
}
kgm ()
{
    k4_search='^%km ' kg $@
}
kgs ()
{
    k4_search='^%ks ' kg $@
}
kgt ()
{
    k4_search='^%kt ' kg $@
}
kh ()
{
    $k4db_logstd "start $$ : $FUNCNAME $@";
    set $(k4_inptr "$1");
    export k4="$1";
    k4db_validate_k4 "$k4" || return 1;
    [ -e "$k4" ] || chkerr "$FUNCNAME no k4='$k4' (bc785a2)" || return 1;
    k4db_hl '#';
    k4_headg "^%k" "$k4" | k4db_squash_defaults;
    k4db_hl '/';
    k4db_mknk4 "0" "$k4";
    $k4db_logstd "end $$ : $FUNCNAME $@"
}
kinv ()
{
    k4_inventory "$(k4_inptr "$1" | awk '{print $1}' )"
}
kj ()
{
    $k4db_logstd "begin $$ : k4since='$k4since' $FUNCNAME $arg";
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    [ "$*" ] || {
        k4_help;
        return 1
    };
    local k4 nd no nx xs arg="$*";
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd d3dde99" || return 1;
    nd="$(knx_count d)";
    k4db_hl '\';
    k4db_fk4 | while read k4; do
        k4_headg "$k4_search" "$k4" | grep "$k4case" -qE "$arg" && {
            nd="$(( nd + 1 ))";
            no="$(printf "%o" "$nd")";
            k4db_mknk4 "$no" "$k4";
            xs="$(k4_headg "^%km " "$k4" | tr '_' ' ' | awk 'NR==1 {print $3}')";
            expr "$xs" : '^[[:xdigit:]]\{8\}$' > /dev/null || xs="........";
            k4_headg '^%ks ' "$k4" | awk -v nd="$nd" -v xs="$xs" 'NR==1 {printf "%2o %8s %s\n",nd,xs,$0}'
        };
    done | $k4_unlong;
    k4db_hl '/';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": k4since='$k4since' $FUNCNAME '$arg' : ";
        k4db_xss_ddiff "$k4db/$k4_pool/tx.${FUNCNAME}" seconds
    } | k4_squeeze | $k4_unlong;
    $k4db_logstd "end $$ : k4since='$k4since' $FUNCNAME $arg"
}
kjj ()
{
    local q;
    for q in $@;
    do
        kj "$q";
    done
}
kjt ()
{
    k4_search="^%kt " kj $@
}
kjv ()
{
    return 1
}
kl ()
{
    local ex="$1";
    local uidlnd="$k4db/$k4_pool/uidln" ptrnxd="$k4db/$k4_pool/ptrnx";
    local xs nxp uidln ptrid;
    k4db_hl '\';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    knx;
    ls "$uidlnd" | while read uidln; do
        nxp=$(grep --files-with-matches "$uidln" "$ptrnxd"/* | head -n1 );
        printf '%- 3s ' "${nxp##*/}";
        xs="${uidln::8}";
        echo -n "$xs ";
        [ "$ex" ] && {
            printf '%s\r' "${xs}";
            k4_headg "$ex" "$uidlnd/$uidln" | k4db_squash_defaults | awk -v xs="$xs" '{printf "\033[12C%s %s\n","",$0}'
        } || {
            k4_headg '^%ks ' "$uidlnd/$uidln" | head -n1
        };
    done | $k4_unlong;
    k4db_hl '/';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": $FUNCNAME $@ {sort acquisi} : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | tr '\n' ' ' | k4_squeeze | $k4_unlong
}
kll ()
{
    kl "$k4_topic"
}
klll ()
{
    kl "$k4_search"
}
klr ()
{
    local ex="$1";
    local uidlnd="$k4db/$k4_pool/uidln" ptrnxd="$k4db/$k4_pool/ptrnx";
    local xs nxp uidln ptrid;
    k4db_hl '\';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    knx;
    ls -r "$uidlnd" | while read uidln; do
        nxp=$(grep --files-with-matches "$uidln" "$ptrnxd"/* | head -n1 );
        printf '%- 3s ' "${nxp##*/}";
        xs="${uidln::8}";
        echo -n "$xs ";
        [ "$ex" ] && {
            printf '%s\r' "${xs}";
            k4_headg "$ex" "$uidlnd/$uidln" | k4db_squash_defaults | awk -v xs="$xs" '{printf "\033[12C%s %s\n","",$0}'
        } || {
            k4_headg '^%ks ' "$uidlnd/$uidln" | head -n1
        };
    done | $k4_unlong;
    k4db_hl '/';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": $FUNCNAME $@ {sort rev-acquisi} : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | tr '\n' ' ' | k4_squeeze | $k4_unlong
}
klrl ()
{
    klr "$k4_topic"
}
klrll ()
{
    klr "$k4_search"
}
kn ()
{
    local xs="$1" k4db="$k4db/$k4_pool/$(k4epoch)";
    echo "$k4_pool/$(k4epoch)"
}
knkr ()
{
    set $(k4_inptr "$1") || return 1;
    local k4="$1";
    k4kr "$k4"
}
knx ()
{
    local ptridc k4;
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd bc72c38" || return 1;
    find "$k4db/$k4_pool/ptrnx" -regex '.*/ptrnx/[[:xdigit:]]*$' -delete;
    find "$k4db/$k4_pool/uidln" -regex '.*/uidln/[[:xdigit:]]\{16\}$' -delete;
    find "$k4db/$k4_pool/ptrid" -regex '.*/ptrid/[[:xdigit:]]\{16\}$' -type f | awk '{printf "%o %s\n",NR,$1}' | while read ptridc; do
        set $ptridc;
        k4="$(head -n1 $2)";
        [ -e "$k4" ] && {
            ln "$2" "$k4db/$k4_pool/ptrnx/$1";
            ln "$k4" "$k4db/$k4_pool/uidln/${2##*/}"
        } || rm -i -f "$2";
    done
}
knx_count ()
{
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd 3ddef4" || return 1;
    local base="$1";
    [ "$base" ] || base="x";
    [ "$base" = "o" -o "$base" = "d" -o "$base" = "x" ] || chkerr "$FUNCNAME : invalid base arg1=(|o|d|x): $base : bc1098ca" || return 1;
    find "$k4db/$k4_pool/ptrnx" -not -name 0 -regex '.*/ptrnx/[[:xdigit:]]*$' | awk 'END{printf "%'$base'\n",NR}'
}
krst ()
{
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd 3ddeb8" || return 1;
    find "$k4db/$k4_pool/ptrnx" -regex '.*/ptrnx/[[:xdigit:]]*$' -delete;
    find "$k4db/$k4_pool/ptrid" -regex '.*/ptrid/[[:xdigit:]]\{16\}$' -delete;
    find "$k4db/$k4_pool/uidln" -regex '.*/uidln/[[:xdigit:]]\{16\}$' -delete;
    k4db_hl '-';
    k4db_hl '\';
    k4pool;
    k4db_hl '/';
    export k4since='';
    k4db_hl '-';
    k4_list_tags;
    k4db_hl '.';
    k4_list_kc;
    k4db_hl '-';
    [ "$@" ] && kj $@
}
krstpool ()
{
    local a;
    k4pool;
    chkwrn "DELETE files in $k4db/$k4_pool";
    read -n1 -p "(y/N) " a;
    echo;
    [ "$a" = "y" ] && {
        find "$k4db/$k4_pool/ptrnx" "$k4db/$k4_pool/ptrid" "$k4db/$k4_pool/uidln" -type f -delete || true
    } || chkwrn cancled
}
ks ()
{
    local invoke="$FUNCNAME $*";
    $k4db_logstd "begin $$ : $invoke";
    local ks="$*";
    set $(echo | tai64n | sed -e 's/^@4[0]*//' -e 's/.\{8\}/& /');
    local xs=$1 ss=$2;
    set $(k4dir_epoch_span "$k4db" "$xs" "$ss");
    local kd="$1" epoch="$2" span="$3";
    mkdir -p "$kd";
    local k4x="$(mktemp ${kd}/_XXXX)";
    local k4hash="$(python $k4db/sub/base.py $(( 0x$xs + 0x$ss )) 32 )";
    export k4="$kd/_${k4hash}.kdb";
    local xa="$(python $k4db/sub/base.py $(( 0x${xs} + 0x${epoch} + ${#epoch} )) 16 )";
    local k4span32="$(python $k4db/sub/base.py $((0x$span)) 32 )";
    local hdate="$(date -j -r "$((0x$xs))" "$k4_ht_strftime")";
    echo "%ks $ks" >> "$k4x";
    local pw="$( gpw 1 $(( ${#epoch} * ${#epoch} / 18 + 4 )) | awk '{printf "%s",$1}' )";
    echo "%kt " >> "$k4x";
    k4_env_r_kc >> "$k4x";
    echo "%kk $epoch $pw $k4hash # class define #" >> "$k4x";
    echo "%kp $epoch $pw $k4hash # hier superord #" >> "$k4x";
    echo "%kj $epoch $pw $k4hash # motive subord #" >> "$k4x";
    echo "%kr $epoch $pw $k4hash # matrix root #" >> "$k4x";
    k4_env_r_kl >> "$k4x";
    echo "%km $xa $xs $ss $epoch $pw $k4hash $k4span32 $hdate" >> "$k4x";
    local kn=$(nevernowf $xs);
    local knfd=$(nevernowd $xs);
    local knfx=$(nevernowx $xs);
    echo "%kn $kn %d $knfd %x $knfx" >> "$k4x";
    local v="$(dc -e "$((0x$xs)) 2 / $((0x$xs)) v + p" | awk '{printf "%08x",$1}')";
    local vv="$(dc -e "$((0x$xs$ss)) v 2 / p" | awk '{printf "%x\n",0x$1}')";
    echo "%kv $v %v $vv # value key #" >> "$k4x";
    local ki="$(k4db_addxd $xs $((86400 * 57)) )";
    local kiht="$(date -j -r 0x$ki "$k4_ht_strftime")";
    echo "%ki $ki $kiht # review interval" >> "$k4x";
    local e="$(printf '%x' "$(( $((0x$xs)) - 86400 * 18 ))" )";
    echo "%ke $e # event begin" >> "$k4x";
    echo "%kz $xs # event end" >> "$k4x";
    [ -e "$k4" ] && k4_headg . "$k4" >> "$k4x";
    printf "\n\n# $ks\n\n" >> "$k4x";
    [ -e "$k4" ] && k4_body . "$k4" >> "$k4x";
    mv -i "$k4x" "$k4";
    k4db_kseq "$k4";
    k4db_validate_k4 "$k4" || return 1;
    ci -m"(by $FUNCNAME)" -l -t-kdb -q "$k4";
    k4db_mknk4 "0" "$k4";
    k 0;
    k4_env_wlink "$k4";
    k4db_idx "$k4";
    $k4db_logstd "end $$ : $invoke"
}
ksyn ()
{
    local k4="$(k4_inptr "$1" | awk '{print $1}' )";
    k4_headg "$k4_topic" "$k4";
    k4_inventory "$k4"
}
kt ()
{
    local ex="$1";
    local xs nxp uidln uidlnd="$k4db/$k4_pool/uidln" ptrnxd="$k4db/$k4_pool/ptrnx";
    k4db_hl '\';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    knx;
    ls -rt "$uidlnd" | while read uidln; do
        nxp=$(grep --files-with-matches "$uidln" "$ptrnxd"/* | head -n1 );
        printf '%- 3s ' "${nxp##*/}";
        xs="${uidln::8}";
        echo -n "$xs ";
        [ "$ex" ] && {
            printf '%s\r' "${xs}";
            k4_headg "$ex" "$uidlnd/$uidln" | k4db_squash_defaults | awk -v xs="$xs" '{printf "\033[12C%s %s\n","",$0}'
        } || {
            k4_headg '^%ks ' "$uidlnd/$uidln" | head -n1
        };
    done | $k4_unlong;
    k4db_hl '/';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": $FUNCNAME $@ {sort mod} : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | tr '\n' ' ' | k4_squeeze | $k4_unlong
}
ktl ()
{
    kt "$k4_topic"
}
ktll ()
{
    kt "$k4_search"
}
ktr ()
{
    local ex="$1";
    local xs nxp uidln uidlnd="$k4db/pool/0/uidln" ptrnxd="$k4db/pool/0/ptrnx";
    k4db_hl '\';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    knx;
    ls -t "$uidlnd" | while read uidln; do
        nxp=$(grep --files-with-matches "$uidln" "$ptrnxd"/* | head -n1 );
        printf '%- 3s ' "${nxp##*/}";
        xs="${uidln::8}";
        echo -n "$xs ";
        [ "$ex" ] && {
            printf '%s\r' "${xs}";
            k4_headg "$ex" "$uidlnd/$uidln" | k4db_squash_defaults | awk -v xs="$xs" '{printf "\033[12C%s %s\n","",$0}'
        } || {
            k4_headg '^%ks ' "$uidlnd/$uidln" | head -n1
        };
    done | $k4_unlong;
    k4db_hl '/';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": $FUNCNAME $@ {sort rev-mod} : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | tr '\n' ' ' | k4_squeeze | $k4_unlong
}
ktrl ()
{
    ktr "$k4_topic"
}
ktrll ()
{
    ktr "$k4_search"
}
kv ()
{
    k4db_valid_cmd || chkerr "$FUNCNAME : fail k4db_valid_cmd bc73b10 " || return 1;
    local uidln uid;
    local filter="$(k4_wrapregex $@)";
    k4db_hl '~';
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.0;
    find $k4db/$k4_pool/uidln -type f | while read uidln; do
        awk 'NR==1,/^%kz/' "$uidln" | grep -E "${k4_search}" | grep $k4case -qE "$filter" && {
            uid="${uidln##*/}";
            rm -i -f "$uidln" "$k4db/$k4_pool/ptrid/$uid"
        };
    done;
    xssdaysec > $k4db/$k4_pool/tx.${FUNCNAME}.1;
    {
        k4db_linkcount ": $FUNCNAME ${k4case} '${filter}' : ";
        k4db_xss_ddiff $k4db/$k4_pool/tx.${FUNCNAME} seconds
    } | $k4_unlong
}
kvl ()
{
    k4_search='^%k(s|m|t|j) ' kv $@
}
kvm ()
{
    k4_search='^%km ' kv $@
}
kvs ()
{
    k4_search='^%ks ' kv $@
}
kvt ()
{
    k4_search='^%kt ' kv $@
}
kwds ()
{
    local w;
    sed -E -e '/^%k(d|r|r|p|nd|nx|no|i|e|v|a|z)(_|\ |$)/d' -e '/^[[:xdigit:]]\{8\}/d' -e 's/http.*( |$)//' | tr -c '[:alnum:]_-=#' ' ' | tr ' ' '\n' | sed -e '/^...$/d' -e '/^..$/d' -e '/^.$/d' -e '/^$/d' -e '/^[[:xdigit:]]\{8\}/d' -e '/^_[[:xdigit:]]\{8\}/d' | aspell -l en munch | tr ' ' '\n' | sed -e 's:/.*::' -e '/^...$/d' -e '/^..$/d' -e '/^.$/d' -e '/^$/d' | sort --ignore-case --unique | while read w; do
        {
            grep -iEq "(^|\ )${w}(\ |$)" "$k4db_ntag" || echo "$w"
        };
    done | while read w; do
        {
            grep -iE "(^|\ )${w}(\ |$)" "$k4db_tags" || echo "$w"
        } | awk '{print $1}';
    done
}
logerr ()
{
    echo ">>> $* <<<" | tai64n >> "${k4db}/${k4_pool}/log"
}
logwrn ()
{
    echo "^^^ $* ^^^" | tai64n >> "${k4db}/${k4_pool}/log"
}
modifyall-headers-without-changing-stat ()
{
    xs=$(xs);
    find "$k4h" -regex '.*/[[:xdigit:]]\{2\}/[[:xdigit:]]\{2\}/[[:xdigit:]]\{4\}/[[:xdigit:]]\{8\}/4000[[:xdigit:]]\{4\}' -exec grep -q '^%k ' \{\} \; -print | while read k4; do
        echo "sed 's/^%k /%ks /' $k4 >${k4}~$xs             && touch -r $k4 ${k4}~$xs             && cat ${k4}~$xs >${k4}             && touch -r ${k4}~$xs $k4             && rm -f ${k4}~$xs";
    done
}
nevernowd ()
{
    local i xs=$1 dxs=$(( 0x$xs ));
    local ke=1438844400 day=86400 is="6 7 9 12 14 16 18 24 28 32 38 43 57 63 86 194";
    local dxs=$(( dxs - day ));
    for i in $is;
    do
        printf '%02d/%02d ' "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" "$i";
    done
}
nevernowf ()
{
    local i xs=$1;
    local dxs=$(( 0x${xs} - day ));
    local ke=1438844400 day=86400 is="6 7 9 12 14 16 18 24 28 32 38 43 57 63 86";
    local ke=1438844400 day=86400 is="6 7 9 12 14";
    for i in $is;
    do
        {
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base.py "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" 4 | awk '{printf "%02s",$1}';
            echo "f";
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base.py "$i" 4 | awk '{printf "%02s",$1}'
        } | tr -d '\n';
        echo -n ' ';
    done;
    local ke=1438844400 day=86400 is="             16 18 24 28 32 38 43 57 63 86 194";
    for i in $is;
    do
        {
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base18.py "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" 4 | awk '{printf "%02s",$1}';
            echo h;
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base18.py "$i" 4 | awk '{printf "%02s",$1}'
        } | tr -d '\n';
        echo -n ' ';
    done
}
nevernowh ()
{
    local i xs=$1;
    local dxs=$(( 0x${xs} - day ));
    local ke=1438844400 day=86400 is="6 7 9 12 14 16 18 24 28 32 38 43 57 63 86 194";
    for i in $is;
    do
        {
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base.py "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" 18 | awk '{printf "%02s",$1}';
            echo h;
            /usr/local//Cellar/python/3.7.3/Frameworks/Python.framework/Versions/3.7/bin/python3.7 $k4db/sub/base.py "$i" 18 | awk '{printf "%02s",$1}'
        } | tr -d '\n';
        echo -n ' ';
    done
}
nevernowo ()
{
    local i;
    local xs=$(xs);
    local dxs=$(printf %d "0x$xs");
    local i xs=$1 dxs=$(( 0x$xs ));
    local ke=1438844400 day=86400 is="6 7 9 12 14 16 18 24 28 32 38 43 57";
    local dxs=$(( dxs - day ));
    for i in $is;
    do
        printf '%02oo%02o ' "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" "$i";
    done;
    echo
}
nevernowx ()
{
    local i;
    local xs=$(xs);
    local dxs=$(printf %d "0x$xs");
    local ke=1438844400 day=86400 is="6 7 9 12 14 16 18 24 28 32 38 43 57 63 86 194";
    local dxs=$(( dxs - day ));
    for i in $is;
    do
        printf '%02xx%02x ' "$(( ( ($dxs - $ke ) % ( $i * $day ) ) / $day + 1  ))" "$i";
    done
}
ptr ()
{
    rev="$(echo "$1" | cut -d\. -f1).$2";
    ip="$(echo "$1" | cut -d\. -f2-)";
    [ "$ip" = "$1" ] && echo "${rev}" || ptr $ip $rev
}
rdot4 ()
{
    ptr $(echo space.dot4.$@ | tr '\t\ ' '.') | tr '.' '\ '
}
rev ()
{
    local in="${*}^" x1i x1o x2o ot;
    [ "$in" = "^" ] && in="$(cat)^";
    [ -z "$(ecp "1" "$in")" ] && {
        ecp "2-" "$in";
        return 0
    };
    x1a="$(ecc "2-" "$in" )";
    x1b="$(ecc "1"  "$in" )";
    x2o="$(ecp "2-" "$in" )";
    ot="${x1a}^${x1b}${x2o}";
    $FUNCNAME "$ot"
}
revbyte ()
{
    return 1
}
revline ()
{
    return 1
}
revword ()
{
    return 1
}
stderr ()
{
    echo ">>> $* <<<" 1>&2
}
stdstd ()
{
    [ "$*" ] && {
        $k4db_logstd "$*";
        echo "$*";
        return 0
    } || true
}
stdwrn ()
{
    echo "^^^ $* ^^^" 1>&2
}
vk4db_env ()
{
    return 1
}
vk4db_head ()
{
    return 1
}
vk4db_headx ()
{
    return 1
}
vk4db_km ()
{
    return 1
}
xs ()
{
    xss | sed -e 's/.\{9\}$//'
}
xs2local ()
{
    local id="$1";
    [ "$id" ] || id="$(cat)";
    echo "$id" | xs2tai | tai64nlocal | sed 's/[\.|][0]*$//'
}
xs2s ()
{
    local xs="$1";
    [ "$xs" ] || xs="$(cat)";
    echo "$xs" | while read n; do
        printf "%d\n" "0x$n";
    done
}
xs2tai ()
{
    sed -e 's/^/@40000000/' -e 's/$/00000000/'
}
xss ()
{
    echo | tai64n | sed -e 's/^@4[0]*//'
}
xssdaysec ()
{
    date "+%Y%m%d %H:%M:%S:%a:%s" | tai64n | sed -e "s/^@4[0]*//" -e 's/^[[:xdigit:]]\{8\}/&_/'
}
